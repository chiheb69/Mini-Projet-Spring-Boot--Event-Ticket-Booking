<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EventHub | Secure Checkout</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <style>
    :root {
      --primary-color: #4f46e5;
      --primary-hover: #4338ca;
      --bg-gradient-start: #f8fafc;
      --bg-gradient-end: #e2e8f0;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
    }

    .booking-card {
      border: none;
      border-radius: 25px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      animation: slideUp 0.6s ease-out;
      background: white;
    }

    .booking-header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      padding: 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .event-info-box {
      background-color: #f8fafc;
      border-radius: 15px;
      padding: 20px;
      border-left: 4px solid var(--primary-color);
      margin-bottom: 25px;
    }

    .form-control {
      border-radius: 10px;
      padding: 12px 15px;
      border: 1px solid #e2e8f0;
      background-color: #f8fafc;
    }

    .form-control:focus {
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      border-color: var(--primary-color);
      background-color: white;
    }

    .btn-confirm {
      background-color: var(--primary-color);
      border: none;
      border-radius: 12px;
      padding: 15px;
      font-weight: 700;
      letter-spacing: 0.5px;
      width: 100%;
      transition: all 0.3s;
      color: white;
    }

    .btn-confirm:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
      color: white;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .back-link {
      color: #64748b;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: var(--primary-color);
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-5 col-md-7">
        <div class="mb-4 text-center">
          <a href="index.html" class="back-link">
            <i class="bi bi-arrow-left me-1"></i> Back to Events
          </a>
        </div>

        <div class="card booking-card">
          <div class="booking-header text-center">
            <i class="bi bi-ticket-detailed-fill display-4 mb-2"></i>
            <h3 class="fw-bold mb-0">Checkout</h3>
            <p class="opacity-75 mb-0">Secure your spot in seconds</p>
          </div>

          <div class="card-body p-4 p-md-5">
            <div id="loader" class="text-center py-4">
              <div class="spinner-border text-primary" role="status"></div>
            </div>

            <div id="booking-content" style="display: none;">
              <div id="event-details" class="event-info-box">
                <!-- Event details injected here -->
              </div>

              <form id="booking-form">
                <input type="hidden" id="eventId">

                <div class="mb-4">
                  <label for="attendeeId" class="form-label fw-bold text-secondary text-uppercase small">Attendee
                    details</label>
                  <div class="input-group">
                    <span class="input-group-text bg-light border-end-0 rounded-start-3">
                      <i class="bi bi-person-badge text-muted"></i>
                    </span>
                    <input type="number" class="form-control border-start-0 rounded-end-3" id="attendeeId" required
                      placeholder="Enter Attendee ID">
                  </div>
                  <div class="form-text ms-1 mt-2">
                    <i class="bi bi-info-circle me-1"></i>
                    Use ID <strong>1</strong> for demo purposes.
                  </div>
                </div>

                <button type="submit" class="btn btn-confirm">
                  Confirm Booking <i class="bi bi-check-circle-fill ms-2"></i>
                </button>
              </form>
            </div>

            <!-- Status Message -->
            <div id="message" class="mt-4"></div>
          </div>
        </div>

        <div class="text-center mt-4 text-muted small">
          <i class="bi bi-lock-fill me-1"></i> Connected to Secure Booking Service (Port 8083)
        </div>
      </div>
    </div>
  </div>

  <script>
    const GATEWAY_URL = 'http://localhost:8888';
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('eventId');

    if (!eventId) {
      window.location.href = 'index.html';
    }

    document.getElementById('eventId').value = eventId;

    async function loadEventDetails() {
      try {
        const response = await fetch(`${GATEWAY_URL}/event-service/api/events/${eventId}`);
        if (!response.ok) throw new Error('Network response was not ok');
        const event = await response.json();

        const dateObj = new Date(event.date);

        document.getElementById('event-details').innerHTML = `
                    <h5 class="fw-bold text-dark mb-2">${event.title}</h5>
                    <div class="d-flex align-items-center text-muted mb-2 small">
                        <i class="bi bi-calendar3 me-2"></i>
                        ${dateObj.toLocaleDateString()} at ${dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div class="d-flex align-items-center text-muted small">
                        <i class="bi bi-geo-alt-fill me-2"></i>
                        ${event.location}
                    </div>
                    <hr class="my-3 opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted small">Price</span>
                        <span class="fw-bold text-success fs-5">$25.00</span>
                    </div>
                `;

        document.getElementById('loader').style.display = 'none';
        document.getElementById('booking-content').style.animation = 'fadeIn 0.5s ease-out';
        document.getElementById('booking-content').style.display = 'block';

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loader').innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="bi bi-x-circle-fill me-2"></i> Event not found.
                    </div>
                `;
        setTimeout(() => window.location.href = 'index.html', 2000);
      }
    }

    document.getElementById('booking-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const attendeeId = document.getElementById('attendeeId').value;
      const btn = document.querySelector('.btn-confirm');
      const messageDiv = document.getElementById('message');

      // Loading state
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
      btn.disabled = true;

      try {
        const response = await fetch(`${GATEWAY_URL}/booking-service/api/bookings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eventId: eventId, attendeeId: attendeeId })
        });

        if (response.ok) {
          messageDiv.innerHTML = `
                        <div class="alert alert-success d-flex align-items-center shadow-sm border-0 bg-success-subtle text-success-emphasis rounded-3">
                            <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                            <div>
                                <strong>Success!</strong><br>
                                Your ticket has been booked successfully.
                            </div>
                        </div>
                    `;
          setTimeout(() => window.location.href = 'index.html', 2500);
        } else {
          const error = await response.json();
          throw new Error(error.message || 'Unknown error');
        }
      } catch (error) {
        btn.innerHTML = 'Try Again';
        btn.disabled = false;
        messageDiv.innerHTML = `
                    <div class="alert alert-danger d-flex align-items-center shadow-sm border-0 bg-danger-subtle text-danger-emphasis rounded-3">
                        <i class="bi bi-x-circle-fill fs-4 me-3"></i>
                        <div>
                            <strong>Booking Failed</strong><br>
                            ${error.message || 'Could not complete booking.'}
                        </div>
                    </div>
                `;
      }
    });

    loadEventDetails();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>